{% extends "base.html" %}

{% block title %}Estatísticas do Grupo {{ grupo_nome }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-chart-bar me-2"></i>
                        Estatísticas do Grupo: <span class="badge bg-primary">{{ grupo_nome }}</span>
                    </h2>
                    <p class="text-muted mb-0">
                        Análise detalhada dos resultados médios dos assessments deste grupo
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <!-- Controle de Auto-Refresh -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="refresh-status-btn">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span id="refresh-status-text">Auto-Refresh: 5s</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><h6 class="dropdown-header">Intervalo de Atualização</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(5); return false;">
                                <i class="fas fa-bolt me-2"></i>5 segundos (Rápido)
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(10); return false;">
                                <i class="fas fa-forward me-2"></i>10 segundos
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(20); return false;">
                                <i class="fas fa-clock me-2"></i>20 segundos
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="setRefreshInterval(60); return false;">
                                <i class="fas fa-hourglass-half me-2"></i>1 minuto
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="setRefreshInterval(0); return false;">
                                <i class="fas fa-pause me-2"></i>Desativado
                            </a></li>
                        </ul>
                    </div>
                    
                    <a href="{{ url_for('admin.listar_grupos') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Voltar aos Grupos
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estatísticas Gerais -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Total de Assessments</h6>
                    <h2 class="text-primary mb-0" id="total-assessments">{{ estatisticas.total_assessments }}</h2>
                    <small class="text-muted">respostas completas</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Pontuação Média</h6>
                    <h2 class="mb-0" id="pontuacao-media" style="color: {% if estatisticas.pontuacao_media_geral >= 80 %}#28a745{% elif estatisticas.pontuacao_media_geral >= 60 %}#ffc107{% else %}#dc3545{% endif %};">
                        {{ estatisticas.pontuacao_media_geral }}%
                    </h2>
                    <small class="text-muted">
                        <i class="fas fa-arrow-down me-1"></i><span id="pontuacao-minima">{{ estatisticas.pontuacao_minima }}%</span>
                        <i class="fas fa-arrow-up ms-2 me-1"></i><span id="pontuacao-maxima">{{ estatisticas.pontuacao_maxima }}%</span>
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Primeira Resposta</h6>
                    <h6 class="text-info mb-0" id="primeira-resposta">{{ estatisticas.primeira_resposta.strftime('%d/%m/%Y %H:%M') }}</h6>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Última Resposta</h6>
                    <h6 class="text-success mb-0" id="ultima-resposta">{{ estatisticas.ultima_resposta.strftime('%d/%m/%Y %H:%M') }}</h6>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tipos de Assessment Utilizados -->
    {% if tipos_utilizados %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Tipos de Assessment Utilizados
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="tipos-utilizados">
                        {% for tipo_data in tipos_utilizados %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <div>
                                    <strong>{{ tipo_data.tipo.nome }}</strong>
                                </div>
                                <div>
                                    <span class="badge bg-primary">{{ tipo_data.quantidade }} respostas</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Estatísticas por Domínio -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>
                        Estatísticas Médias por Domínio
                    </h5>
                    <div class="btn-group" role="group" aria-label="Tipo de visualização">
                        <button type="button" class="btn btn-sm btn-outline-primary active" onclick="changeChartType('bar')" id="btn-bar">
                            <i class="fas fa-chart-bar me-1"></i>Barras Verticais
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changeChartType('horizontalBar')" id="btn-horizontalBar">
                            <i class="fas fa-grip-lines me-1"></i>Barras Horizontais
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changeChartType('radar')" id="btn-radar">
                            <i class="fas fa-chart-area me-1"></i>Radar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleTable()" id="btn-table">
                            <i class="fas fa-table me-1"></i>Tabela
                        </button>
                    </div>
                </div>
                
                <!-- Gráfico -->
                <div class="card-body" id="chart-container" style="display: block;">
                    {% if dominios_estatisticas %}
                    <canvas id="dominiosChart" style="max-height: 400px;"></canvas>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum domínio respondido encontrado.</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Tabela -->
                <div class="card-body p-0" id="table-container" style="display: none;">
                    {% if dominios_estatisticas %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Domínio</th>
                                    <th class="text-center">Média</th>
                                    <th class="text-center">Mínima</th>
                                    <th class="text-center">Máxima</th>
                                    <th class="text-center">Respostas</th>
                                    <th>Barra de Progresso</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dominios_estatisticas %}
                                <tr>
                                    <td>
                                        <strong>{{ item.dominio.nome }}</strong>
                                        {% if item.dominio.descricao %}
                                        <br><small class="text-muted">{{ item.dominio.descricao[:80] }}{% if item.dominio.descricao|length > 80 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <h5 class="mb-0" style="color: {% if item.media >= 80 %}#28a745{% elif item.media >= 60 %}#ffc107{% else %}#dc3545{% endif %};">
                                            {{ item.media }}%
                                        </h5>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">{{ item.minima }}%</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ item.maxima }}%</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ item.total_respostas }}</span>
                                    </td>
                                    <td style="width: 30%;">
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar {% if item.media >= 80 %}bg-success{% elif item.media >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ item.media }}%;" 
                                                 aria-valuenow="{{ item.media }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ item.media }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhum domínio respondido encontrado.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Legenda de cores -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Legenda de Pontuações</h6>
                    <div class="d-flex gap-4 flex-wrap">
                        <div>
                            <span class="badge bg-success me-2">80% - 100%</span>
                            <small class="text-muted">Excelente</small>
                        </div>
                        <div>
                            <span class="badge bg-warning me-2">60% - 79%</span>
                            <small class="text-muted">Bom</small>
                        </div>
                        <div>
                            <span class="badge bg-danger me-2">0% - 59%</span>
                            <small class="text-muted">Precisa Melhorar</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Chart.js Datalabels Plugin para rótulos nas barras -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
// Dados dos domínios para os gráficos
const dominiosData = {
    labels: [
        {% for item in dominios_estatisticas %}
        "{{ item.dominio.nome }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    medias: [
        {% for item in dominios_estatisticas %}
        {{ item.media }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    minimas: [
        {% for item in dominios_estatisticas %}
        {{ item.minima }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    maximas: [
        {% for item in dominios_estatisticas %}
        {{ item.maxima }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
};

// Função para determinar cor baseada no valor
function getColor(value) {
    if (value >= 80) return '#28a745'; // Verde (Excelente)
    if (value >= 60) return '#ffc107'; // Amarelo (Bom)
    return '#dc3545'; // Vermelho (Precisa Melhorar)
}

// Criar array de cores para cada domínio
const backgroundColors = dominiosData.medias.map(value => getColor(value));

let currentChart = null;
let currentType = 'bar';

// Função para criar/atualizar gráfico
function createChart(type) {
    const ctx = document.getElementById('dominiosChart');
    if (!ctx) return;
    
    // Destruir gráfico anterior se existir
    if (currentChart) {
        currentChart.destroy();
    }
    
    let chartConfig = {
        type: type === 'horizontalBar' ? 'bar' : type,
        data: {
            labels: dominiosData.labels,
            datasets: [{
                label: 'Média (%)',
                data: dominiosData.medias,
                backgroundColor: type === 'radar' ? 'rgba(54, 162, 235, 0.2)' : backgroundColors,
                borderColor: type === 'radar' ? 'rgb(54, 162, 235)' : backgroundColors,
                borderWidth: type === 'radar' ? 2 : 1,
                fill: type === 'radar',
                pointBackgroundColor: type === 'radar' ? backgroundColors : undefined,
                pointBorderColor: type === 'radar' ? backgroundColors : undefined,
                pointRadius: type === 'radar' ? 5 : undefined,
                pointHoverRadius: type === 'radar' ? 7 : undefined
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: type === 'radar',
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value;
                            if (currentType === 'radar') {
                                value = context.parsed.r;
                            } else if (currentType === 'horizontalBar') {
                                value = context.parsed.x;
                            } else {
                                value = context.parsed.y;
                            }
                            return context.dataset.label + ': ' + value + '%';
                        }
                    }
                },
                datalabels: {
                    display: type !== 'radar', // Mostrar apenas em gráficos de barras
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    formatter: function(value) {
                        return value + '%';
                    },
                    anchor: 'center',
                    align: 'center'
                }
            },
            scales: type === 'radar' ? {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            } : {
                y: type === 'horizontalBar' ? {
                    beginAtZero: true,
                    max: 100
                } : {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: type === 'horizontalBar' ? {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                } : {}
            }
        }
    };
    
    // Configuração específica para barras horizontais
    if (type === 'horizontalBar') {
        chartConfig.options.indexAxis = 'y';
    }
    
    currentChart = new Chart(ctx, chartConfig);
}

// Função para mudar tipo de gráfico
function changeChartType(type) {
    currentType = type;
    
    // Atualizar botões ativos
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('btn-' + type).classList.add('active');
    
    // Mostrar gráfico, esconder tabela
    document.getElementById('chart-container').style.display = 'block';
    document.getElementById('table-container').style.display = 'none';
    
    // Criar novo gráfico
    createChart(type);
}

// Função para alternar para tabela
function toggleTable() {
    // Atualizar botões ativos
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById('btn-table').classList.add('active');
    
    // Mostrar tabela, esconder gráfico
    document.getElementById('chart-container').style.display = 'none';
    document.getElementById('table-container').style.display = 'block';
}

// Função para atualizar dados via AJAX
async function atualizarEstatisticas() {
    try {
        const response = await fetch('{{ url_for("admin.estatisticas_grupo_api", grupo_nome=grupo_nome) }}');
        if (!response.ok) return;
        
        const data = await response.json();
        
        // Atualizar estatísticas gerais
        document.getElementById('total-assessments').textContent = data.estatisticas.total_assessments;
        document.getElementById('pontuacao-media').textContent = data.estatisticas.pontuacao_media_geral + '%';
        document.getElementById('pontuacao-minima').textContent = data.estatisticas.pontuacao_minima + '%';
        document.getElementById('pontuacao-maxima').textContent = data.estatisticas.pontuacao_maxima + '%';
        document.getElementById('primeira-resposta').textContent = data.estatisticas.primeira_resposta;
        document.getElementById('ultima-resposta').textContent = data.estatisticas.ultima_resposta;
        
        // Atualizar tipos utilizados
        const tiposContainer = document.getElementById('tipos-utilizados');
        if (tiposContainer && data.tipos_utilizados.length > 0) {
            tiposContainer.innerHTML = data.tipos_utilizados.map(tipo => `
                <div class="col-md-6 mb-2">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                        <div>
                            <strong>${tipo.nome}</strong>
                        </div>
                        <div>
                            <span class="badge bg-primary">${tipo.quantidade} respostas</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Atualizar dados dos gráficos
        dominiosData.labels = data.dominios_estatisticas.map(d => d.nome);
        dominiosData.medias = data.dominios_estatisticas.map(d => d.media);
        dominiosData.minimas = data.dominios_estatisticas.map(d => d.minima);
        dominiosData.maximas = data.dominios_estatisticas.map(d => d.maxima);
        
        // Recriar gráfico se estiver visível (não em modo tabela)
        if (document.getElementById('chart-container').style.display !== 'none') {
            createChart(currentType);
        }
        
        // Atualizar tabela se estiver visível
        if (document.getElementById('table-container').style.display !== 'none') {
            const tbody = document.querySelector('#table-container tbody');
            if (tbody) {
                tbody.innerHTML = data.dominios_estatisticas.map(d => {
                    const badgeClass = d.media >= 80 ? 'bg-success' : (d.media >= 60 ? 'bg-warning' : 'bg-danger');
                    return `
                        <tr>
                            <td><strong>${d.nome}</strong></td>
                            <td><span class="badge ${badgeClass}">${d.media}%</span></td>
                            <td>${d.minima}%</td>
                            <td>${d.maxima}%</td>
                            <td>${d.total_respostas}</td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
    } catch (error) {
        console.error('Erro ao atualizar estatísticas:', error);
    }
}

// Controle de intervalo de refresh
let refreshIntervalId = null;
let currentRefreshInterval = 5; // Padrão: 5 segundos

// Carregar preferência salva do localStorage
function loadRefreshPreference() {
    const saved = localStorage.getItem('grupoRefreshInterval');
    if (saved !== null) {
        currentRefreshInterval = parseInt(saved);
    }
    updateRefreshStatus();
}

// Salvar preferência no localStorage
function saveRefreshPreference(seconds) {
    localStorage.setItem('grupoRefreshInterval', seconds.toString());
}

// Atualizar texto do botão de status
function updateRefreshStatus() {
    const statusText = document.getElementById('refresh-status-text');
    const statusBtn = document.getElementById('refresh-status-btn');
    
    if (currentRefreshInterval === 0) {
        statusText.textContent = 'Auto-Refresh: OFF';
        statusBtn.classList.remove('btn-outline-info');
        statusBtn.classList.add('btn-outline-danger');
    } else {
        let text = 'Auto-Refresh: ';
        if (currentRefreshInterval < 60) {
            text += currentRefreshInterval + 's';
        } else {
            text += (currentRefreshInterval / 60) + 'min';
        }
        statusText.textContent = text;
        statusBtn.classList.remove('btn-outline-danger');
        statusBtn.classList.add('btn-outline-info');
    }
}

// Configurar intervalo de refresh
function setRefreshInterval(seconds) {
    // Limpar intervalo anterior
    if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
    }
    
    currentRefreshInterval = seconds;
    saveRefreshPreference(seconds);
    updateRefreshStatus();
    
    // Configurar novo intervalo se não for 0 (desativado)
    if (seconds > 0) {
        refreshIntervalId = setInterval(atualizarEstatisticas, seconds * 1000);
        console.log(`Auto-refresh ativado: ${seconds}s`);
        
        // Feedback visual
        const statusBtn = document.getElementById('refresh-status-btn');
        statusBtn.classList.add('text-success');
        setTimeout(() => statusBtn.classList.remove('text-success'), 500);
    } else {
        console.log('Auto-refresh desativado');
    }
}

// Inicializar gráfico ao carregar a página
{% if dominios_estatisticas %}
document.addEventListener('DOMContentLoaded', function() {
    createChart('bar');
    
    // Carregar preferência e iniciar auto-refresh
    loadRefreshPreference();
    setRefreshInterval(currentRefreshInterval);
});
{% endif %}
</script>
{% endblock %}
